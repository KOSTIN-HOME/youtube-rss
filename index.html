<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>YouTube RSS Viewer</title>

<style>
:root {
    --bg: #0f0f0f;
    --bg2: #181818;
    --text: #ffffff;
    --sub: #aaaaaa;
    --accent: #ff0000;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
}

/* LAYOUT */
#app {
    display: flex;
    height: 100vh;
}

/* PLAYER */
#player {
    flex: 1.6;
    padding: 20px;
}

.player-wrapper {
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000;
    border-radius: 14px;
    overflow: hidden;
}

/* FEED */
#feed {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    border-left: 1px solid #222;
}

.video {
    display: flex;
    gap: 12px;
    padding: 10px;
    border-radius: 12px;
    cursor: pointer;
}

.video:hover {
    background: var(--bg2);
}

.thumb {
    width: 168px;
    aspect-ratio: 16 / 9;
    border-radius: 10px;
    object-fit: cover;
}

.title {
    font-size: 15px;
    font-weight: 500;
}

.meta {
    font-size: 13px;
    color: var(--sub);
    margin-top: 6px;
}

#loader {
    padding: 20px;
    color: var(--sub);
    font-size: 14px;
}

/* ================= MOBILE ================= */

@media (max-width: 900px) {
    #app {
        flex-direction: column;
        height: auto;
    }

    #player {
        padding: 12px;
    }

    .player-wrapper {
        border-radius: 0;
    }

    #feed {
        border-left: none;
        border-top: 1px solid #222;
    }

    .thumb {
        width: 120px;
    }
}
</style>
</head>

<body>

<div id="app">

    <div id="player">
        <div class="player-wrapper" id="playerWrapper"></div>
    </div>

    <div id="feed">
        <div id="loader">Подготовка…</div>
    </div>

</div>

<script>
/* ================= CONFIG ================= */

const feeds = [
  "https://www.youtube.com/feeds/videos.xml?channel_id=UCUzkWdUCkVrkKCcmut9epTQ",
  "https://www.youtube.com/feeds/videos.xml?channel_id=UCdKuE7a2QZeHPhDntXVZ91w"
];

const proxy = url =>
  `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

/* ================= STATE ================= */

const feedEl = document.getElementById("feed");
const loaderEl = document.getElementById("loader");
const playerWrapper = document.getElementById("playerWrapper");

const videoMap = new Map();

/* ================= INIT ================= */

init();

/* ================= FUNCTIONS ================= */

async function init() {
    loaderEl.textContent = `Загружаем каналы (0 / ${feeds.length})…`;

    await Promise.all(
        feeds.map(async (feed, i) => {
            loaderEl.textContent =
                `Загружаем канал ${i + 1} из ${feeds.length}…`;
            await loadFeed(feed);
        })
    );

    renderFinal();
}

async function loadFeed(feedUrl) {
    try {
        const res = await fetch(proxy(feedUrl), { cache: "no-store" });
        const text = await res.text();
        parseFeed(text);
    } catch (e) {
        console.warn("Ошибка загрузки:", feedUrl);
    }
}

function parseFeed(text) {
    const xml = new DOMParser().parseFromString(text, "text/xml");

    xml.querySelectorAll("entry").forEach(e => {
        let id = e.querySelector("yt\\:videoId")?.textContent;

        if (!id) {
            const link = e.querySelector("link")?.getAttribute("href") || "";
            const match = link.match(/v=([^&]+)/);
            if (match) id = match[1];
        }

        if (!id || videoMap.has(id)) return;

        videoMap.set(id, {
            id,
            title: e.querySelector("title")?.textContent || "",
            channel: e.querySelector("author name")?.textContent || "",
            date: new Date(e.querySelector("published")?.textContent)
        });
    });
}

function renderFinal() {
    loaderEl.textContent =
        `Готово. Найдено видео: ${videoMap.size}`;

    const videos = [...videoMap.values()]
        .sort((a, b) => b.date - a.date);

    videos.forEach(renderVideo);
}

function renderVideo(v) {
    const div = document.createElement("div");
    div.className = "video";

    div.innerHTML = `
        <img class="thumb" src="https://i.ytimg.com/vi/${v.id}/hqdefault.jpg">
        <div>
            <div class="title">${v.title}</div>
            <div class="meta">
                ${v.channel} • ${v.date.toLocaleDateString("ru-RU")}
            </div>
        </div>
    `;

    div.onclick = () => loadVideo(v.id);
    feedEl.appendChild(div);
}

function loadVideo(id) {
    playerWrapper.innerHTML = `
        <iframe
            src="https://www.youtube.com/embed/${id}?autoplay=1&rel=0"
            allow="autoplay; encrypted-media; picture-in-picture"
            allowfullscreen
            style="width:100%;height:100%;border:none">
        </iframe>
    `;
}
</script>

</body>
</html>
