<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>YouTube RSS Viewer</title>

<style>
:root{
    --bg:#0f0f0f;
    --bg2:#181818;
    --text:#fff;
    --sub:#aaa;
    --accent:#ff0000;
    --activeVideo:#555;
}
*{box-sizing:border-box}
body{margin:0;font-family:Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
button{cursor:pointer}

/* ===== LOGIN SCREEN ===== */
#lockScreen{
    position:fixed;inset:0;background:#0f0f0f;
    display:flex;align-items:center;justify-content:center;z-index:9999;
}
#loginBox{
    background:#181818;padding:20px;border-radius:14px;width:420px;
    display:flex;flex-direction:column;gap:10px;
}
#passRow{display:flex;gap:10px}
#passwordInput{
    flex:1;padding:8px;border-radius:8px;
    border:1px solid #333;background:#000;color:#fff;
}
#loginBtn{
    padding:8px 14px;border-radius:8px;border:none;
    background:var(--accent);color:#fff;
}
#feedsInput{
    width:100%;height:160px;
    background:#000;color:#fff;
    border:1px solid #333;border-radius:8px;
    padding:8px;font-family:monospace;font-size:13px;
}
#actionRow{display:flex;gap:10px}
#saveBtn,#deleteBtn{
    flex:1;padding:8px;border-radius:8px;
    background:#222;color:#fff;border:1px solid #333;
}

/* ===== APP ===== */
#app{display:none;height:100vh}
#player{flex:1.6;padding:20px;display:flex;flex-direction:column;gap:10px}
.player-wrapper{width:100%;aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden}
#videoInfo{font-size:14px;color:var(--sub)}
#feedContainer{flex:1;display:flex;flex-direction:column;border-left:1px solid #222}
#tabs{display:flex;gap:8px;flex-wrap:wrap;padding:12px;background:var(--bg2);border-bottom:1px solid #222}
.tab{padding:6px 12px;border-radius:8px;background:#222;color:var(--sub);cursor:pointer}
.tab.active{background:var(--activeVideo);color:#fff}
.tab.updating{animation:blinkGreen 1s infinite}
@keyframes blinkGreen{0%,100%{color:#8BC34A}50%{opacity:.5}}
#feed{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.video{display:flex;gap:12px;padding:10px;border-radius:12px;cursor:pointer;background:var(--bg2)}
.video:hover{background:#333}
.video.active{background:var(--activeVideo)}
.thumb{width:168px;aspect-ratio:16/9;border-radius:10px}
.title{font-size:15px;font-weight:500}
.meta{font-size:13px;color:var(--sub);margin-top:6px}
#loader{padding:20px;color:var(--sub)}
</style>
</head>

<body>

<div id="lockScreen">
    <div id="loginBox">
        <div id="passRow">
            <input id="passwordInput" type="password" placeholder="Пароль">
            <button id="loginBtn">Войти</button>
        </div>
        <textarea id="feedsInput" placeholder='
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=...",name:"Channel"}
'></textarea>
        <div id="actionRow">
            <button id="saveBtn">Записать</button>
            <button id="deleteBtn">Удалить</button>
        </div>
    </div>
</div>

<div id="app">
    <div id="player">
        <div id="videoInfo">Выберите видео</div>
        <div class="player-wrapper" id="playerWrapper"></div>
    </div>
    <div id="feedContainer">
        <div id="tabs"></div>
        <div id="feed"><div id="loader">Подготовка…</div></div>
    </div>
</div>

<script>
/* ===== AUTH / STORAGE ===== */
const usersKey = "ytUsers";
let currentHash = null;
let feeds = [];

async function sha256(t){
    const b=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(t));
    return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("");
}
function getUsers(){return JSON.parse(localStorage.getItem(usersKey)||"{}")}
function saveUsers(u){localStorage.setItem(usersKey,JSON.stringify(u))}

loginBtn.onclick = async ()=>{
    const h = await sha256(passwordInput.value);
    const users = getUsers();
    if(users[h]){
        currentHash = h;
        feeds = users[h].feeds;
        startApp();
    }
};

saveBtn.onclick = async ()=>{
    const h = await sha256(passwordInput.value);
    let parsed;
    try{ parsed = eval("["+feedsInput.value+"]"); }
    catch{ return alert("Ошибка формата feeds"); }
    const users = getUsers();
    users[h] = { feeds: parsed };
    saveUsers(users);
    alert("Сохранено");
};

deleteBtn.onclick = async ()=>{
    const h = await sha256(passwordInput.value);
    const users = getUsers();
    delete users[h];
    saveUsers(users);
    Object.keys(localStorage)
        .filter(k=>k.includes(h))
        .forEach(k=>localStorage.removeItem(k));
    alert("Удалено");
};

/* ===== ORIGINAL CODE (НЕ МЕНЯЛ) ===== */
const proxies=[
u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
u=>`https://cors.isomorphic-git.org/${u}`,
u=>`https://thingproxy.freeboard.io/fetch/${u}`
];
async function proxyFetch(url){
    return Promise.any(proxies.map(p=>fetch(p(url),{cache:"no-store"}).then(r=>{if(!r.ok)throw 0;return r})));
}

const tabsEl=document.getElementById("tabs");
const feedEl=document.getElementById("feed");
const loaderEl=document.getElementById("loader");
const playerWrapper=document.getElementById("playerWrapper");
const videoInfoEl=document.getElementById("videoInfo");

const iframe=document.createElement("iframe");
iframe.allow="autoplay";iframe.allowFullscreen=true;
iframe.style="width:100%;height:100%;border:none";
playerWrapper.appendChild(iframe);

const videoMap=new Map();
const channelStatus=new Map();
let currentTab="Все видео";
let currentVideoId=null;
let videosLoaded=0,videosToRender=[];

function startApp(){
    lockScreen.style.display="none";
    app.style.display="flex";
    init();
}

function init(){
    renderTabs();
    feeds.forEach(f=>channelStatus.set(f.name,"loading"));
    feeds.forEach(loadFeed);
    renderVideosSorted();
}

async function loadFeed(feed){
    try{
        const r=await proxyFetch(feed.url);
        parseFeed(await r.text(),feed.name);
        channelStatus.set(feed.name,"loaded");
    }catch{}
    renderVideosSorted();
}

function renderTabs(){
    tabsEl.innerHTML="";
    ["Все видео",...feeds.map(f=>f.name)].forEach(n=>{
        const t=document.createElement("div");
        t.className="tab"+(n===currentTab?" active":"");
        t.textContent=n;
        t.onclick=()=>{currentTab=n;renderTabs();renderVideosSorted()};
        tabsEl.appendChild(t);
    });
}

function parseFeed(text,channel){
    const xml=new DOMParser().parseFromString(text,"text/xml");
    xml.querySelectorAll("entry").forEach(e=>{
        const id=e.querySelector("yt\\:videoId")?.textContent;
        if(!id)return;
        videoMap.set(id,{
            id,title:e.querySelector("title").textContent,
            channel,date:new Date(e.querySelector("published").textContent)
        });
    });
}

function renderVideosSorted(reset=true){
    if(reset){
        feedEl.innerHTML="";
        videosLoaded=0;
        videosToRender=[...videoMap.values()]
            .filter(v=>currentTab==="Все видео"||v.channel===currentTab)
            .sort((a,b)=>b.date-a.date);
    }
    videosToRender.slice(videosLoaded,videosLoaded+20).forEach(v=>{
        const d=document.createElement("div");
        d.className="video"+(v.id===currentVideoId?" active":"");
        d.innerHTML=`
        <img class="thumb" src="https://i.ytimg.com/vi/${v.id}/hqdefault.jpg">
        <div><div class="title">${v.title}</div>
        <div class="meta">${v.channel}</div></div>`;
        d.onclick=()=>loadVideo(v);
        feedEl.appendChild(d);
    });
    videosLoaded+=20;
}

function loadVideo(v){
    iframe.src=`https://www.youtube.com/embed/${v.id}?autoplay=1`;
    videoInfoEl.textContent=`${v.title} — ${v.channel}`;
    currentVideoId=v.id;
}
</script>
</body>
</html>
