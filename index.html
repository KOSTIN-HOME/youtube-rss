<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>YouTube RSS Viewer</title>

<style>
:root {
    --bg:#0f0f0f;
    --bg2:#181818;
    --text:#fff;
    --sub:#aaa;
    --accent:#ff0000;
    --activeVideo:#555555;
}
*{box-sizing:border-box}
body{margin:0;font-family:Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
#app{display:flex;height:100vh}
#player{flex:1.6;padding:20px;display:flex;flex-direction:column;gap:10px}
.player-wrapper{width:100%;aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden}
#videoInfo{font-size:14px;color:var(--sub);min-height:20px}
#feedContainer{flex:1;display:flex;flex-direction:column;border-left:1px solid #222}
#tabs{display:flex;gap:8px;flex-wrap:wrap;padding:12px;background:var(--bg2);border-bottom:1px solid #222}

/* ----------------- Доработка вкладок ----------------- */
.tab {
    padding:6px 12px;
    border-radius:8px;
    cursor:pointer;
    background:#222;
    color:var(--sub);
    font-size:14px;
    white-space:nowrap;
    transition: background 0.2s, color 0.2s; /* плавный переход */
}

.tab:hover {
    background: #333; /* как видео при наведении */
    color: #fff;
}

.tab.active {
    background: var(--activeVideo); /* как выбранное видео */
    color: #fff;
}
/* ------------------------------------------------------ */

.tab.loading::after{
    content:"";display:inline-block;margin-left:6px;width:12px;height:12px;
    border:2px solid var(--text);border-top-color:var(--accent);
    border-radius:50%;animation:spin .8s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes blinkGreen {
  0%, 100% { color: #8BC34A; opacity: 1; }
  50% { color: #C5E1A5; opacity: 0.5; }
}

.tab.updating {
  animation: blinkGreen 1s infinite;
}

#retryFailed{
    margin:8px;
    padding:6px 10px;
    background:#222;
    color:#fff;
    border:1px solid #333;
    border-radius:8px;
    cursor:pointer;
}

#feed{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.video{display:flex;gap:12px;padding:10px;border-radius:12px;cursor:pointer;background:var(--bg2)}
.video:hover{background:#333}
.video.active{background:var(--activeVideo);}
.thumb{width:168px;aspect-ratio:16/9;border-radius:10px;object-fit:cover}
.title{font-size:15px;font-weight:500}
.meta{font-size:13px;color:var(--sub);margin-top:6px}
#loader{padding:20px;color:var(--sub)}

@media (max-width: 768px) {
    #app {flex-direction: column;height:auto}
    #player {flex:none;padding:10px}
    #feedContainer {flex:none;border-left:none;border-top:1px solid #222}
    #feed {overflow-y:visible}
}
</style>
</head>

<body>

<!-- Пункт 1: защита паролем -->
<div id="lockScreen" style="
    position:fixed;
    inset:0;
    background:#0f0f0f;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
">
    <div style="background:#181818;padding:20px;border-radius:12px;min-width:260px">
        <div style="margin-bottom:10px;color:#aaa">Введите пароль</div>
        <input id="passwordInput" type="password" style="
            width:100%;
            padding:8px;
            border-radius:8px;
            border:1px solid #333;
            background:#000;
            color:#fff;
        ">
    </div>
</div>

<div id="app">
<div id="player">
    <div id="videoInfo">Выберите видео</div>
    <div class="player-wrapper" id="playerWrapper"></div>
</div>

<div id="feedContainer">
    <div id="tabs"></div>
    <div id="feed"><div id="loader">Подготовка…</div></div>
</div>
</div>

<script>
const feeds=[
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCUzkWdUCkVrkKCcmut9epTQ",name:"DeadP47"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCdKuE7a2QZeHPhDntXVZ91w",name:"Kuplinov"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCDF_NIAEkcAUvzxe1DUzaQA",name:"Rozetked"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCXvyU8oMwCmGOYYutgNwyiw",name:"Acting"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UC_gKMJFeCf1bKzZr_fICkig",name:"TheDRZJ"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UC2q4mHrzoR48mwSuAYtVPtQ",name:"Александр Панчин"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCgtAOyEQdAyjvm9ATCi_Aig",name:"AlexGyver"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UC76KmU4gIQqVHZ3ESydElHA",name:"Черный Кумыс"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UC-_iyv1-5NM5wmypELjz8Aw",name:"Максим Кузнецов"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UC6uFoHcr_EEK6DgCS-LeTNA",name:"PRO Hi-Tech"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCHPwlUYfCZ1RzYNyZKvaRHw",name:"Portal News"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCI_OoGWEN7HHet11pNTFdJg",name:"Илья Геймер"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCsvsmFQ8eFRx5v6cdmuYBsg",name:"Restart"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCyPvbjMjnQBn-6FcxxovSHA",name:"Луцай"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCkrzQDo3U2GmHqqMjqYOuvA",name:"LoVisH Gaming Experience"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCOw9Jzw3p4XzL5Ub5WglJRQ",name:"Алексей Макаренков"}
];

const PASSWORD_HASH = "346058ad3f947af4bd7c1dbe70ed1c155eafc95d856c9e781b25e871f0b736e6";
const lockScreen = document.getElementById("lockScreen");
const passwordInput = document.getElementById("passwordInput");

window.addEventListener("load", () => passwordInput.focus());

passwordInput.addEventListener("blur", () => {
    if (lockScreen.style.display !== "none") {
        setTimeout(() => passwordInput.focus(), 0);
    }
});

async function sha256(text) {
    const data = new TextEncoder().encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    return [...new Uint8Array(hashBuffer)]
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

passwordInput.addEventListener("input", async () => {
    const hash = await sha256(passwordInput.value);
    if (hash === PASSWORD_HASH) {
        lockScreen.style.display = "none";
    }
});

const channelOrder = new Map(feeds.map((f,i)=>[f.name,i]));

const proxies=[
u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
u=>`https://cors.isomorphic-git.org/${u}`,
u=>`https://thingproxy.freeboard.io/fetch/${u}`
];

async function proxyFetch(url) {
    const promises = proxies.map(p => 
        fetch(p(url), { cache: "no-store" }).then(r => {
            if (!r.ok) throw new Error();
            return r;
        })
    );
    return Promise.any(promises);
}

const tabsEl=document.getElementById("tabs");
const feedEl=document.getElementById("feed");
const loaderEl=document.getElementById("loader");
const playerWrapper=document.getElementById("playerWrapper");
const videoInfoEl=document.getElementById("videoInfo");

const playerIframe = document.createElement("iframe");
playerIframe.allow = "autoplay";
playerIframe.allowFullscreen = true;
playerIframe.style.width = "100%";
playerIframe.style.height = "100%";
playerIframe.style.border = "none";
playerWrapper.appendChild(playerIframe);

const videoMap=new Map();
const channelStatus=new Map();
let currentTab="Все видео";
let currentVideoId = null;
const maxRetries=2;
let videosPerPage = 20;
let videosLoaded = 0;
let videosToRender = [];

init();

function init(){
    const saved = localStorage.getItem("ytVideos");
    if(saved){
        JSON.parse(saved).forEach(v=>{
            v.date = new Date(v.date);
            videoMap.set(v.id,v);
        });
    }

    renderTabs();
    feeds.forEach(f=>channelStatus.set(f.name,"loading"));
    feeds.forEach(f=>loadFeedWithRetries(f,maxRetries));

    setInterval(checkNewVideos,10*60*1000);

    // Рендерим "Все видео" сразу
    renderVideosSorted();
}

async function loadFeedWithRetries(feed) {
    channelStatus.set(feed.name, "loading");
    finalizeTabs();

    try {
        const r = await proxyFetch(feed.url);
        const t = await r.text();
        parseFeed(t, feed.name);
        channelStatus.set(feed.name, "loaded");
    } catch (err) {
        setTimeout(() => loadFeedWithRetries(feed), 10000);
        return;
    } finally {
        finalizeTabs();
        renderVideosSorted();
    }
}

function checkNewVideos(){
    feeds.forEach(f=>loadFeedWithRetries(f,maxRetries));
}

function finalizeTabs(){
    const all = tabsEl.querySelector('[data-channel="Все видео"]');
    const tabs = [...tabsEl.querySelectorAll(".tab")].filter(t => t !== all);

    tabs.sort((a,b) => channelOrder.get(a.dataset.channel) - channelOrder.get(b.dataset.channel));

    tabsEl.innerHTML = "";
    tabsEl.appendChild(all);

    tabs.forEach(t => {
        const name = t.dataset.channel;
        const status = channelStatus.get(name);

        t.classList.remove("updating");
        if(status === "loading"){
            t.classList.add("updating");
        } else {
            t.style.color = "#aaa";
        }

        tabsEl.appendChild(t);
    });
}

function renderTabs(){
    tabsEl.innerHTML="";
    tabsEl.appendChild(createTab("Все видео"));
    feeds.forEach(f=>tabsEl.appendChild(createTab(f.name)));
}

function createTab(name){
    const t=document.createElement("div");
    t.className="tab"+(name===currentTab?" active":"");
    t.dataset.channel=name;
    t.textContent=name;
    t.onclick=()=>{
        currentTab=name;
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        renderVideosSorted();
    };
    return t;
}

function parseFeed(text,channel){
    const xml=new DOMParser().parseFromString(text,"text/xml");
    let channelVideos = [];

    xml.querySelectorAll("entry").forEach(e=>{
        let id=e.querySelector("yt\\:videoId")?.textContent;
        if(!id){
            const link=e.querySelector("link")?.getAttribute("href")||"";
            const m=link.match(/v=([^&]+)/);
            if(m) id=m[1];
        }
        if(!id) return;

        const video={
            id,
            title:e.querySelector("title")?.textContent||"",
            channel,
            date:new Date(e.querySelector("published")?.textContent)
        };
        videoMap.set(id,video);
        channelVideos.push(video);
    });

    // Сохраняем только последние 20 видео на канал
    const saved = JSON.parse(localStorage.getItem("ytVideos")||"[]");
    const otherVideos = saved.filter(v=>v.channel!==channel);
    channelVideos.sort((a,b)=>b.date-a.date);
    localStorage.setItem("ytVideos",JSON.stringify([...otherVideos, ...channelVideos.slice(0,20)]));
}

// Рендер с подсветкой активного видео
function renderVideosSorted(reset = true) {
    if (reset) {
        feedEl.innerHTML = "";
        videosLoaded = 0;
        videosToRender = [...videoMap.values()]
            .filter(v => currentTab === "Все видео" || v.channel === currentTab)
            .sort((a, b) => b.date - a.date);
    }

    let slice = videosToRender.slice(videosLoaded, videosLoaded + videosPerPage);
    slice.forEach(v => {
        const d = document.createElement("div");
        d.className = "video" + (v.id===currentVideoId?" active":"");
        d.dataset.videoId = v.id;
        d.innerHTML = `
            <img class="thumb" src="https://i.ytimg.com/vi/${v.id}/hqdefault.jpg">
            <div>
                <div class="title">${v.title}</div>
                <div class="meta">
                    ${v.channel} • ${v.date.toLocaleDateString("ru-RU")}
                </div>
            </div>`;
        d.onclick = () => loadVideo(v);
        feedEl.appendChild(d);
    });

    videosLoaded += slice.length;

    loaderEl.style.display = videosLoaded < videosToRender.length ? "block" : "none";
}

feedEl.addEventListener("scroll", () => {
    if (feedEl.scrollTop + feedEl.clientHeight >= feedEl.scrollHeight - 50) {
        if (videosLoaded < videosToRender.length) {
            renderVideosSorted(false);
        }
    }
});

function loadVideo(v){
    playerIframe.src = `https://www.youtube.com/embed/${v.id}?playsinline=1&autoplay=1`;
    videoInfoEl.textContent = `${v.title} — ${v.channel}`;
    currentVideoId = v.id;

    document.querySelectorAll(".video").forEach(x => x.classList.remove("active"));
    const el = document.querySelector(`.video[data-video-id="${v.id}"]`);
    if(el) el.classList.add("active");

    // Сохраняем последнее видео
    localStorage.setItem("ytLastVideo", v.id);
}

// Восстанавливаем последнее видео
window.addEventListener("load", () => {
    const last = localStorage.getItem("ytLastVideo");
    if(last && videoMap.has(last)){
        loadVideo(videoMap.get(last));
    }
});
</script>
</body>
</html>
