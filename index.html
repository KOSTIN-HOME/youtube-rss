<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KvadTube</title>

<style>
body{margin:0;background:#000;color:#fff;font-family:sans-serif}
#setup, #app{padding:12px}
#app{display:flex;height:100vh;gap:12px}
textarea,input{background:#111;color:#fff;border:1px solid #333;border-radius:6px;padding:6px}
button{background:#111;color:#aaa;border:1px solid #333;border-radius:6px;padding:6px 10px}
#feed{overflow:auto;flex:1}
.video{display:flex;gap:8px;padding:6px;cursor:pointer}
.video:hover{background:#222}
.video.active{background:#444}
img{width:140px;border-radius:6px}
iframe{width:100%;height:100%;border:0}
@media(max-width:800px){#app{flex-direction:column}}
</style>

<body>

<div id="setup" hidden>
<textarea id="feeds" placeholder='["https://www.youtube.com/feeds/videos.xml?channel_id=..."]'></textarea>
<br><button onclick="saveFeeds()">OK</button>
</div>

<div id="app" hidden>
<div style="flex:1.6">
<div>
<span id="title">Выберите видео</span>
<input id="time" placeholder="чч:мм" size="5">
</div>
<div style="aspect-ratio:16/9;background:#000;margin-top:6px">
<iframe id="player" allow="autoplay" allowfullscreen></iframe>
</div>
</div>
<div id="feed"></div>
</div>

<script>
const S={f:"feeds",v:"videos",t:"time",l:"last"}
const $=id=>document.getElementById(id)
let vids=[],cur=null

if(!localStorage[S.f])$("setup").hidden=false
else init()

function saveFeeds(){
  localStorage[S.f]=$("feeds").value
  $("setup").remove()
  init()
}

function init(){
  $("app").hidden=false
  vids=JSON.parse(localStorage[S.v]||"[]").map(v=>(v.date=new Date(v.date),v))
  load()
}

async function load(){
  const feeds=JSON.parse(localStorage[S.f])
  for(const u of feeds){
    try{
      const r=await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent(u))
      parse(await r.text())
    }catch{}
  }
  localStorage[S.v]=JSON.stringify(vids)
  render()
}

function parse(x){
  const xml=new DOMParser().parseFromString(x,"text/xml")
  xml.querySelectorAll("entry").forEach(e=>{
    const id=e.querySelector("yt\\:videoId")?.textContent
    if(!id||vids.find(v=>v.id==id))return
    vids.push({id,title:e.querySelector("title")?.textContent||"",
      date:new Date(e.querySelector("published")?.textContent)})
  })
}

function render(){
  $("feed").innerHTML=""
  vids.sort((a,b)=>b.date-a.date).forEach(v=>{
    const d=document.createElement("div")
    d.className="video"+(v.id==cur?" active":"")
    d.innerHTML=`<img src=https://i.ytimg.com/vi/${v.id}/hqdefault.jpg>
    <div><div>${v.title}</div><small>${v.date.toLocaleString("ru-RU")}</small></div>`
    d.onclick=_=>play(v)
    $("feed").appendChild(d)
  })
}

function play(v){
  cur=v.id
  $("title").textContent=v.title
  const t=JSON.parse(localStorage[S.t]||"{}")[v.id]||""
  $("time").value=t
  $("player").src=`https://www.youtube.com/embed/${v.id}?autoplay=1&start=${sec(t)}`
  localStorage[S.l]=v.id
  render()
}

function sec(t){
  const m=t.match(/(\d+):(\d+)/)
  return m?m[1]*3600+m[2]*60:0
}

$("time").onchange=_=>{
  if(!cur)return
  const o=JSON.parse(localStorage[S.t]||"{}")
  o[cur]=$("time").value
  localStorage[S.t]=JSON.stringify(o)
}
</script>
</body>
</html>
