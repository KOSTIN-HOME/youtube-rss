<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>KvadTube</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#111;
  color:#ddd;
}
#setup, #app{padding:10px}
textarea{
  width:100%;
  height:200px;
  background:#000;
  color:#ddd;
  border:1px solid #333;
}
button{
  background:#222;
  color:#ddd;
  border:1px solid #333;
  padding:6px 10px;
}
iframe{
  width:100%;
  height:50vh;
  border:none;
  background:#000;
}
#list{
  margin-top:10px;
}
.item{
  border-bottom:1px solid #222;
  padding:6px 0;
}
.item small{color:#888}
.item input{
  width:60px;
  background:#000;
  color:#ddd;
  border:1px solid #333;
  margin-left:10px;
}
</style>
</head>

<body>

<div id="setup" hidden>
<textarea id="input"></textarea>
<button id="save">OK</button>
</div>

<div id="app" hidden>
<iframe id="player"></iframe>
<div id="list"></div>
</div>

<script>
const LS_CHANNELS='channels'
const LS_VIDEOS='videos'
const proxies=[
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://cors.isomorphic-git.org/${u}`,
  u=>`https://thingproxy.freeboard.io/fetch/${u}`
]

const $=id=>document.getElementById(id)

let channels=JSON.parse(localStorage.getItem(LS_CHANNELS)||'null')
let videos=JSON.parse(localStorage.getItem(LS_VIDEOS)||'[]')

if(!channels){
  $('setup').hidden=false
  $('save').onclick=()=>{
    channels=JSON.parse($('input').value)
    localStorage.setItem(LS_CHANNELS,JSON.stringify(channels))
    start()
  }
}else start()

function start(){
  $('setup').hidden=true
  $('app').hidden=false
  render()
  fetchAll()
  setInterval(fetchAll,30*60*1000)
}

async function fetchFeed(url){
  for(const p of proxies){
    try{
      const t = await fetch(p(url)).then(r=>r.text())
      if(t.includes('<entry>')) return t
    }catch{}
  }
  throw 'RSS not loaded'
}


async function fetchAll(){
  let added=false
  for(const ch of channels){
    const xml=await fetchFeed(ch.url)
    const doc=new DOMParser().parseFromString(xml,'text/xml')
    doc.querySelectorAll('entry').forEach(e=>{
      const id=e.querySelector('yt\\:videoId')?.textContent
      if(!id||videos.find(v=>v.id===id)) return
      videos.push({
        id,
        title:e.querySelector('title').textContent,
        channel:ch.name,
        date:new Date(e.querySelector('published').textContent).getTime(),
        note:''
      })
      added=true
    })
  }
  if(added){
    videos.sort((a,b)=>b.date-a.date)
    localStorage.setItem(LS_VIDEOS,JSON.stringify(videos))
    render()
  }
}

function render(){
  if(videos[0]) $('player').src=`https://www.youtube.com/embed/${videos[0].id}`
  $('list').innerHTML=''
  videos.forEach(v=>{
    const d=new Date(v.date)
    const el=document.createElement('div')
    el.className='item'
    el.innerHTML=`
      <div>
        <b>${v.title}</b>
        <small> — ${v.channel} — ${d.toLocaleString().slice(0,-3)}</small>
        <input maxlength="5" value="${v.note}">
      </div>
    `
    el.onclick=()=>$('player').src=`https://www.youtube.com/embed/${v.id}`
    el.querySelector('input').oninput=e=>{
      v.note=e.target.value
      localStorage.setItem(LS_VIDEOS,JSON.stringify(videos))
    }
    $('list').appendChild(el)
  })
}
</script>

</body>
</html>

