<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>KvadTube</title>

<style>
:root{
    --bg:#0f0f0f;
    --bg2:#181818;
    --hover:#333;
    --border:#333;
    --active:#555;
    --text:#fff;
    --sub:#aaa;
    --accent:#ff0000;

    --r-sm:8px;
    --r-md:12px;
    --pad-sm:8px;
    --pad-md:12px;
    --pad-lg:20px;

    --anim:.2s ease;
}

*{box-sizing:border-box}
body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:Roboto,Arial,sans-serif;
}
img{display:block}

#app{display:flex;height:100vh}
.flex{display:flex}
.col{flex-direction:column}
.row{display:flex;gap:8px}
.gap{gap:12px}

#player{flex:1.6;padding:var(--pad-lg);display:flex;flex-direction:column;gap:10px}
#feedContainer{flex:1;display:flex;flex-direction:column;border-left:1px solid #222}

.card{
    background:var(--bg2);
    border-radius:var(--r-md);
}
.interactive{
    cursor:pointer;
    transition:background var(--anim), color var(--anim);
}
.interactive:hover{background:var(--hover)}
.active{background:var(--active)!important}

.player-wrapper{
    aspect-ratio:16/9;
    background:#000;
    border-radius:14px;
    overflow:hidden;
}
#videoInfo{font-size:14px;color:var(--sub)}

#tabs{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    padding:var(--pad-md);
    background:var(--bg2);
    border-bottom:1px solid #222;
}
.tab{
    padding:6px 12px;
    border-radius:var(--r-sm);
    font-size:14px;
    color:var(--sub);
}
.tab.loading::after{
    content:"";
    width:12px;height:12px;
    margin-left:6px;
    display:inline-block;
    border:2px solid var(--text);
    border-top-color:var(--accent);
    border-radius:50%;
    animation:spin .8s linear infinite;
}
.tab.updating{animation:blink 2s infinite;color:#a0bfa0}

#feed{
    flex:1;
    overflow-y:auto;
    padding:var(--pad-md);
    display:flex;
    flex-direction:column;
    gap:10px;
}
.video{
    display:flex;
    gap:12px;
    padding:10px;
    border-radius:var(--r-md);
    color:#ccc;
}
.thumb{
    width:168px;
    aspect-ratio:16/9;
    border-radius:10px;
    object-fit:cover;
}
.title{font-size:15px;font-weight:500}
.meta{font-size:13px;color:var(--sub);margin-top:6px}

button,input,textarea{
    padding:var(--pad-sm) var(--pad-md);
    border-radius:var(--r-sm);
    border:1px solid var(--border);
    background:var(--bg2);
    color:var(--text);
    font-size:13px;
}
button{cursor:pointer}
button:hover{background:var(--hover)}
textarea,input{background:var(--bg);font-family:monospace;width:100%}

#lockScreen{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:var(--bg);
    z-index:9999;
}
#lockScreen .box{
    min-width:420px;
    padding:var(--pad-lg);
}
#lockScreen label{
    display:block;
    margin-bottom:6px;
    font-size:14px;
    color:var(--sub);
}

#loader{padding:20px;color:var(--sub)}

@keyframes spin{to{transform:rotate(360deg)}}
@keyframes blink{50%{opacity:.6}}

@media (max-width:768px){
    #app{flex-direction:column;height:auto}
    #player{padding:10px}
    #feedContainer{border-left:none;border-top:1px solid #222}
    #feed{overflow:visible}
}
</style>
</head>

<body>

<div id="lockScreen">
    <div class="box">
        <label for="passwordInput">Пароль</label>
        <div class="row">
            <input id="passwordInput" type="password">
            <button id="loginBtn">Войти</button>
        </div>

        <label for="feedsInput">Каналы</label>
        <textarea id="feedsInput" rows="5" spellcheck="false"
            placeholder='{url:"https://www.youtube.com/feeds/videos.xml?channel_id=...", name:"Channel"}'></textarea>

        <div class="row-large">
            <button id="saveBtn">Записать</button>
            <button id="deleteBtn">Удалить</button>
        </div>

        <div id="lockMsg"></div>
    </div>
</div>

<div id="app">
<div id="player">
    <div id="videoInfo">Выберите видео</div>
    <div class="player-wrapper" id="playerWrapper"></div>
</div>

<div id="feedContainer">
    <div id="tabs"></div>
    <div id="feed"><div id="loader">Подготовка…</div></div>
</div>
</div>

<script>

const lockScreen = document.getElementById("lockScreen");
const passwordInput = document.getElementById("passwordInput");

window.addEventListener("load", () => passwordInput.focus());

let feeds = [];
let currentPassword = "";
    
const loginBtn  = document.getElementById("loginBtn");
const saveBtn   = document.getElementById("saveBtn");
const deleteBtn = document.getElementById("deleteBtn");
const feedsInput = document.getElementById("feedsInput");
const lockMsg = document.getElementById("lockMsg");

function getStorageKey(pass) {
    return `ytFeeds_${pass}`;
}

function parseFeedsInput(text){
    try {
        return Function("return [" + text + "]")();
    } catch {
        return null;
    }
}

loginBtn.onclick = () => {
    const pass = passwordInput.value;
    const saved = localStorage.getItem(getStorageKey(pass));

    if (!saved) {
        lockMsg.textContent = "Каналы для этого пароля не найдены";
        return;
    }

    feeds = JSON.parse(saved);
    currentPassword = pass;
    lockScreen.style.display = "none";
    init();
};

saveBtn.onclick = () => {
    const pass = passwordInput.value;
    const parsed = parseFeedsInput(feedsInput.value);

    if (!parsed || !Array.isArray(parsed)) {
        lockMsg.textContent = "Ошибка формата feeds";
        return;
    }

    localStorage.setItem(getStorageKey(pass), JSON.stringify(parsed));
    lockMsg.textContent = "Каналы сохранены";

    feedsInput.value = "";
};

deleteBtn.onclick = () => {
    const pass = passwordInput.value;
    localStorage.removeItem(getStorageKey(pass));
    localStorage.removeItem(`ytVideos_${pass}`);
    localStorage.removeItem("ytLastVideo");
    lockMsg.textContent = "Каналы и кэш удалены";
};

let channelOrder;

const proxies=[
u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
u=>`https://cors.isomorphic-git.org/${u}`,
u=>`https://thingproxy.freeboard.io/fetch/${u}`
];

async function proxyFetch(url){
    return Promise.any(
        proxies.map(p => fetch(p(url), {cache:"no-store"}).then(r=>r.ok?r:Promise.reject()))
    );
}

const tabsEl=document.getElementById("tabs");
const feedEl=document.getElementById("feed");
const loaderEl=document.getElementById("loader");
const playerWrapper=document.getElementById("playerWrapper");
const videoInfoEl=document.getElementById("videoInfo");

const playerIframe = document.createElement("iframe");
playerIframe.allow = "autoplay";
playerIframe.allowFullscreen = true;
playerIframe.style.width = "100%";
playerIframe.style.height = "100%";
playerIframe.style.border = "none";
playerWrapper.appendChild(playerIframe);

const videoMap=new Map();
const channelStatus=new Map();
let currentTab="Все видео";
let currentVideoId = null;
const maxRetries=2;
let videosPerPage = 20;
let videosLoaded = 0;
let videosToRender = [];

function init(){
    if(!currentPassword) return;

    channelOrder = new Map(feeds.map((f, i) => [f.name, i]));

    videoMap.clear();

    const saved = JSON.parse(localStorage.getItem(`ytVideos_${currentPassword}`) || "[]");
    saved.forEach(v => {
        v.date = new Date(v.date);
        videoMap.set(v.id, v);
    });

    updateTabs();

    feeds.forEach(f => channelStatus.set(f.name, "loading"));
    feeds.forEach(f => loadFeedWithRetries(f, maxRetries));

    setInterval(checkNewVideos, 10*60*1000);
    
    renderVideosSorted();
}

async function loadFeedWithRetries(feed) {
    channelStatus.set(feed.name, "loading");
    updateTabs();

    try {
        const r = await proxyFetch(feed.url);
        const t = await r.text();
        parseFeed(t, feed.name);
        channelStatus.set(feed.name, "loaded");
    } catch (err) {
        setTimeout(() => loadFeedWithRetries(feed), 10000);
        return;
    } finally {
        updateTabs();
        renderVideosSorted();
    }
}

function checkNewVideos(){
    feeds.forEach(f=>loadFeedWithRetries(f,maxRetries));
}

function updateTabs(){
    tabsEl.innerHTML = "";
    tabsEl.appendChild(createTab("Все видео"));
    feeds.sort((a,b) => channelOrder.get(a.name) - channelOrder.get(b.name))
         .forEach(f => {
             const t = createTab(f.name);
             if(channelStatus.get(f.name) === "loading") t.classList.add("updating");
             tabsEl.appendChild(t);
         });
}

function createTab(name){
    const t=document.createElement("div");
    t.className="tab"+(name===currentTab?" active":"");
    t.dataset.channel=name;
    t.textContent=name;
    t.onclick=()=>{
        currentTab=name;
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        renderVideosSorted();
    };
    return t;
}

function parseFeed(text,channel){
    const xml=new DOMParser().parseFromString(text,"text/xml");
    let channelVideos = [];

    xml.querySelectorAll("entry").forEach(e=>{
        let id=e.querySelector("yt\\:videoId")?.textContent;
        if(!id){
            const link=e.querySelector("link")?.getAttribute("href")||"";
            const m=link.match(/v=([^&]+)/);
            if(m) id=m[1];
        }
        if(!id) return;

        const video={
            id,
            title:e.querySelector("title")?.textContent||"",
            channel,
            date:new Date(e.querySelector("published")?.textContent)
        };
        videoMap.set(id,video);
        channelVideos.push(video);
    });

    if(!currentPassword) return;
    const saved = JSON.parse(localStorage.getItem(`ytVideos_${currentPassword}`) || "[]");
    const otherVideos = saved.filter(v => v.channel !== channel);
    channelVideos.sort((a,b) => b.date - a.date);
    localStorage.setItem(`ytVideos_${currentPassword}`, JSON.stringify([...otherVideos, ...channelVideos.slice(0,20)]));
}

function renderVideosSorted(reset = true) {
    if (reset) {
        feedEl.innerHTML = "";
        videosLoaded = 0;
        videosToRender = [...videoMap.values()]
            .filter(v => currentTab === "Все видео" || v.channel === currentTab)
            .sort((a, b) => b.date - a.date);
    }

    let slice = videosToRender.slice(videosLoaded, videosLoaded + videosPerPage);
    slice.forEach(v => feedEl.appendChild(createVideoCard(v)));

    videosLoaded += slice.length;

    loaderEl.style.display = videosLoaded < videosToRender.length ? "block" : "none";
}

feedEl.addEventListener("scroll", () => {
    if (feedEl.scrollTop + feedEl.clientHeight >= feedEl.scrollHeight - 50) {
        if (videosLoaded < videosToRender.length) {
            renderVideosSorted(false);
        }
    }
});

function createVideoCard(v){
    const d = document.createElement("div");
    d.className = "video" + (v.id===currentVideoId?" active":"");
    d.dataset.videoId = v.id;
    d.innerHTML = `
        <img class="thumb" src="https://i.ytimg.com/vi/${v.id}/hqdefault.jpg">
        <div>
            <div class="title">${v.title}</div>
            <div class="meta">${v.channel} • ${v.date.toLocaleDateString("ru-RU")}</div>
        </div>`;
    d.onclick = () => loadVideo(v);
    return d;
}

function loadVideo(v){
    playerIframe.src = `https://www.youtube.com/embed/${v.id}?playsinline=1&autoplay=1`;
    videoInfoEl.textContent = `${v.title} — ${v.channel}`;
    currentVideoId = v.id;

    document.querySelectorAll(".video").forEach(x => x.classList.remove("active"));
    const el = document.querySelector(`.video[data-video-id="${v.id}"]`);
    if(el) el.classList.add("active");

}
</script>
</body>
</html>










