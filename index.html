<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>YouTube RSS Viewer</title>

<style>
:root {
    --bg:#0f0f0f;
    --bg2:#181818;
    --text:#fff;
    --sub:#aaa;
    --accent:#ff0000;
}
*{box-sizing:border-box}
body{margin:0;font-family:Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
#app{display:flex;height:100vh}
#player{flex:1.6;padding:20px;display:flex;flex-direction:column;gap:10px}
.player-wrapper{width:100%;aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden}
#videoInfo{font-size:14px;color:var(--sub);min-height:20px}
#feedContainer{flex:1;display:flex;flex-direction:column;border-left:1px solid #222}
#tabs{display:flex;gap:8px;flex-wrap:wrap;padding:12px;background:var(--bg2);border-bottom:1px solid #222}
.tab{padding:6px 12px;border-radius:8px;cursor:pointer;background:#222;color:var(--sub);font-size:14px;white-space:nowrap}
.tab.active{background:var(--accent);color:#fff}
@keyframes blinkGreen {
  0%, 100% { color: #8BC34A; opacity: 1; }
  50% { color: #C5E1A5; opacity: 0.5; }
}
.tab.updating { animation: blinkGreen 1s infinite; }

#feed{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.video{display:flex;gap:12px;padding:10px;border-radius:12px;cursor:pointer;background:var(--bg2)}
.video:hover{background:#333}
.thumb{width:168px;aspect-ratio:16/9;border-radius:10px;object-fit:cover}
.title{font-size:15px;font-weight:500}
.meta{font-size:13px;color:var(--sub);margin-top:6px}
#loader{padding:20px;color:var(--sub)}

@media (max-width: 768px) {
    #app {flex-direction: column;height:auto}
    #player {flex:none;padding:10px}
    #feedContainer {flex:none;border-left:none;border-top:1px solid #222}
    #feed {overflow-y:visible}
}
</style>
</head>

<body>

<!-- lock -->
<div id="lockScreen" style="position:fixed;inset:0;background:#0f0f0f;display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#181818;padding:20px;border-radius:12px;min-width:260px">
        <div style="margin-bottom:10px;color:#aaa">Введите пароль</div>
        <input id="passwordInput" type="password" style="width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#000;color:#fff;">
    </div>
</div>

<div id="app">
<div id="player">
    <div id="videoInfo">Выберите видео</div>
    <div class="player-wrapper" id="playerWrapper"></div>
</div>

<div id="feedContainer">
    <div id="tabs"></div>
    <div id="feed"><div id="loader">Подготовка…</div></div>
</div>
</div>

<script>
const feeds=[
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCUGfDbfRIx51kJGGHIFo8Rw",name:"МК"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCgpSieplNxXxLXYAzJLLpng",name:"МН"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCVVNJJXC7TQgPpAjQdgrqNw",name:"АШ"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UChNZYkhBgv4GNEo6N1kwm_A",name:"СИТ"},
{url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCIpvyH9GKI54X1Ww2BDnEgg",name:"БИ"}
];

const PASSWORD_HASH="346058ad3f947af4bd7c1dbe70ed1c155eafc95d856c9e781b25e871f0b736e6";
const lockScreen=document.getElementById("lockScreen");
const passwordInput=document.getElementById("passwordInput");

window.addEventListener("load",()=>passwordInput.focus());

async function sha256(text){
    const data=new TextEncoder().encode(text);
    const hashBuffer=await crypto.subtle.digest("SHA-256",data);
    return [...new Uint8Array(hashBuffer)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
passwordInput.addEventListener("input",async()=>{
    if(await sha256(passwordInput.value)===PASSWORD_HASH){
        lockScreen.style.display="none";
    }
});

const proxies=[
u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
u=>`https://cors.isomorphic-git.org/${u}`,
u=>`https://thingproxy.freeboard.io/fetch/${u}`
];
function proxyFetch(url){
    return Promise.any(proxies.map(p=>fetch(p(url),{cache:"no-store"})));
}

const tabsEl=document.getElementById("tabs");
const feedEl=document.getElementById("feed");
const loaderEl=document.getElementById("loader");
const playerWrapper=document.getElementById("playerWrapper");
const videoInfoEl=document.getElementById("videoInfo");

const playerIframe=document.createElement("iframe");
playerIframe.allow="autoplay";
playerIframe.allowFullscreen=true;
playerIframe.style.width="100%";
playerIframe.style.height="100%";
playerIframe.style.border="none";
playerWrapper.appendChild(playerIframe);

const videoMap=new Map();
const channelStatus=new Map();
let currentTab="Все видео";

let videosPerPage=20;
let videosLoaded=0;
let videosToRender=[];

let lastTime=0;

window.addEventListener("message",e=>{
    if(!e.data||typeof e.data!=="string"||!e.data.includes("infoDelivery"))return;
    try{
        const d=JSON.parse(e.data);
        if(d?.info?.currentTime){
            lastTime=Math.floor(d.info.currentTime);
            localStorage.setItem("lastVideoTime",lastTime);
        }
    }catch{}
});

function saveVideos(){
    const limit=20;
    const grouped={};
    [...videoMap.values()].forEach(v=>{
        if(!grouped[v.channel])grouped[v.channel]=[];
        grouped[v.channel].push(v);
    });
    const out=Object.values(grouped).flatMap(arr=>arr.sort((a,b)=>b.date-a.date).slice(0,limit));
    localStorage.setItem("ytVideos",JSON.stringify(out));
}

init();

function init(){
    const saved=localStorage.getItem("ytVideos");
    if(saved){
        JSON.parse(saved).forEach(v=>{
            v.date=new Date(v.date);
            videoMap.set(v.id,v);
        });
    }

    renderTabs();
    renderVideosSorted();

    feeds.forEach(f=>{
        channelStatus.set(f.name,"loading");
        loadFeed(f);
    });

    const lastId=localStorage.getItem("lastVideo");
    const t=parseInt(localStorage.getItem("lastVideoTime")||"0",10);
    if(lastId&&videoMap.has(lastId)){
        loadVideo(videoMap.get(lastId),t);
    }
}

async function loadFeed(feed){
    channelStatus.set(feed.name,"loading");
    finalizeTabs();
    try{
        const r=await proxyFetch(feed.url);
        parseFeed(await r.text(),feed.name);
        channelStatus.set(feed.name,"loaded");
    }catch{
        channelStatus.set(feed.name,"error");
    }finally{
        finalizeTabs();
        renderVideosSorted();
    }
}

function renderTabs(){
    tabsEl.innerHTML="";
    tabsEl.appendChild(createTab("Все видео"));
    feeds.forEach(f=>tabsEl.appendChild(createTab(f.name)));
}

function createTab(name){
    const t=document.createElement("div");
    t.className="tab"+(name===currentTab?" active":"");
    t.dataset.channel=name;
    t.textContent=name;
    t.onclick=()=>{
        if(currentTab===name)return;
        currentTab=name;
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        renderVideosSorted();
    };
    return t;
}

function finalizeTabs(){
    tabsEl.querySelectorAll(".tab").forEach(t=>{
        const s=channelStatus.get(t.dataset.channel);
        t.classList.toggle("updating",s==="loading");
    });
}

function parseFeed(text,channel){
    const xml=new DOMParser().parseFromString(text,"text/xml");
    xml.querySelectorAll("entry").forEach(e=>{
        const title=e.querySelector("title")?.textContent||"";
        if(/#shorts/i.test(title))return;

        const id=e.querySelector("yt\\:videoId")?.textContent;
        if(!id||videoMap.has(id))return;

        videoMap.set(id,{
            id,
            title,
            channel,
            date:new Date(e.querySelector("published")?.textContent)
        });
    });
    saveVideos();
}

function renderVideosSorted(reset=true){
    if(reset){
        feedEl.innerHTML="";
        videosLoaded=0;
        videosToRender=[...videoMap.values()]
            .filter(v=>currentTab==="Все видео"||v.channel===currentTab)
            .sort((a,b)=>b.date-a.date);
    }

    const slice=videosToRender.slice(videosLoaded,videosLoaded+videosPerPage);
    slice.forEach(v=>{
        const imgPreload=new Image();
        imgPreload.src=`https://i.ytimg.com/vi/${v.id}/hqdefault.jpg`;

        const d=document.createElement("div");
        d.className="video";
        d.innerHTML=`
            <img class="thumb" src="${imgPreload.src}">
            <div>
                <div class="title">${v.title}</div>
                <div class="meta">${v.channel} • ${v.date.toLocaleDateString("ru-RU")}</div>
            </div>`;
        d.onclick=()=>loadVideo(v,0);
        feedEl.appendChild(d);
    });
    videosLoaded+=slice.length;
    loaderEl.style.display=videosLoaded<videosToRender.length?"block":"none";
}

feedEl.addEventListener("scroll",()=>{
    if(feedEl.scrollTop+feedEl.clientHeight>=feedEl.scrollHeight-50){
        if(videosLoaded<videosToRender.length){
            renderVideosSorted(false);
        }
    }
});

function loadVideo(v,start=0){
    playerIframe.src=`https://www.youtube.com/embed/${v.id}?enablejsapi=1&autoplay=1&playsinline=1&start=${start}`;
    videoInfoEl.textContent=`${v.title} — ${v.channel}`;
    localStorage.setItem("lastVideo",v.id);
}
</script>
</body>
</html>
